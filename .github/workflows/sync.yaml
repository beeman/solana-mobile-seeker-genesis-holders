name: Sync

on:
  schedule:
    - cron: '0 * * * *' # every hour
  workflow_dispatch:
    inputs:
      epoch:
        description: 'Specific epoch to re-index (leave empty for default sync)'
        required: false
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Environment
        uses: ./.github/actions/setup

      - name: Run migrations
        run: bunx drizzle-kit migrate
        env:
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}

      - name: Run sync
        run: |
          if [ -n "${{ inputs.epoch }}" ]; then
            bun run src/index.ts --epoch ${{ inputs.epoch }}
          else
            bun run src/index.ts
          fi
        env:
          SOLANA_ENDPOINT: ${{ secrets.SOLANA_ENDPOINT }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
